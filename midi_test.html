<!DOCTYPE html>
<html>
  <head>
    <title>Drum Visualizer</title>
  </head>
  <body>
    <h1>Drum Visualizer</h1>
    <div id="drum-container">
      <div class="drum" id="kick">Kick</div>
      <div class="drum" id="hihat">Hi-Hat</div>
      <div class="drum" id="snare">Snare</div>
      <div class="drum" id="tom1">Tom 1</div>
      <div class="drum" id="tom2">Tom 2</div>
      <div class="drum" id="tom3">Tom 3</div>
      <div class="drum" id="tom4">Tom 4</div>
      <div class="drum" id="crash1">Crash 1</div>
      <div class="drum" id="crash2">Crash 2</div>
      <div class="drum" id="ride">Ride</div>
    </div>
    <pre id="midi-log">Waiting for MIDI input...</pre>
    <script>
      // Check if Web MIDI is supported
      if (navigator.requestMIDIAccess) {
        console.log('Web MIDI is supported');
        navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
      } else {
        console.log('Web MIDI is not supported');
        document.getElementById('midi-log').textContent = 'Web MIDI is not supported in this browser.';
      }

      // MIDI note mapping for BlackHawk drum HXD 4 Pro
      const DRUM_MAPPING = {
        36: 'kick',    
        42: 'hihat',   
        38: 'snare',   
        45: 'tom1',    
        47: 'tom2',    
        48: 'tom3',    
        50: 'tom4',    
        49: 'crash1',  
        57: 'crash2',  
        51: 'ride'     
      };

      function onMIDISuccess(midiAccess) {
        console.log('MIDI Access granted');
        const inputs = midiAccess.inputs.values();
        let inputFound = false;
        
        for (let input of inputs) {
          console.log('Found MIDI input:', input.name);
          inputFound = true;
          document.getElementById('midi-log').textContent += '\nConnected to: ' + input.name;
          input.onmidimessage = handleMIDIMessage;
        }
        
        if (!inputFound) {
          console.log('No MIDI inputs found');
          document.getElementById('midi-log').textContent += '\nNo MIDI inputs found';
        }
      }

      function onMIDIFailure(error) {
        console.log('Failed to connect to MIDI devices:', error);
        document.getElementById('midi-log').textContent = 'Failed to connect to MIDI devices: ' + error;
      }

      function handleMIDIMessage(message) {
        const [command, note, velocity] = message.data;
        console.log('MIDI Message received:', { command, note, velocity });
        
        // Only process note-on messages (144) with velocity > 0
        if (command === 144 && velocity > 0) {
          console.log('Processing drum hit:', DRUM_MAPPING[note]);
          const drumElement = document.getElementById(DRUM_MAPPING[note]);
          if (drumElement) {
            console.log('Found drum element, updating visual');
            // Visual feedback
            drumElement.style.backgroundColor = 'red';
            setTimeout(() => {
              drumElement.style.backgroundColor = '';
            }, 100);
          } else {
            console.log('No drum element found for note:', note);
          }
          
          document.getElementById('midi-log').textContent += `\nDrum: ${DRUM_MAPPING[note]}, Velocity: ${velocity}`;
        }
      }
    </script>
  </body>
</html>
